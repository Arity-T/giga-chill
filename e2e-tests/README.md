# E2E Тесты для Giga Chill

## Описание

Данная папка содержит End-to-End тесты для всего приложения Giga Chill, включая фронтенд и бэкенд. Тесты написаны с использованием Cypress и тестируют полные пользовательские сценарии.

## Предварительные требования

- Node.js v16+
- Запущенный фронтенд на `http://localhost:3001`
- Запущенный и настроенный бэкенд

## Установка зависимостей

```bash
cd e2e-tests
npm install
```

## Запуск тестов

### Все тесты (автоматический режим)
```bash
npm test
```

### Отдельные тесты
```bash
npm run test:specific "cypress/e2e/user-flow.cy.ts"    # Полный сценарий
```

### Интерактивный режим (GUI)
```bash
npm run test:open
```

### Запуск с видимым браузером
```bash
npm run test:headed
```

## Рекомендации по написанию тестов

0. Перед запуском тестового сценария очищаем базу данных. Для этого на бэке выделен специальный эндпоинт `/test-utils/cleanup`.
   ```ts
   before(() => {
        cy.request('POST', 'http://localhost:3000/test-utils/cleanup');
    });
   ```
1. При использовании `contains` первым параметром указываем селектор.
   ```ts
   // Так не делаем
   cy.contains('Добавить участника');
   // Так делаем
   cy.contains('button', 'Добавить участника');
   ```
2. Сужаем область поиска элементов с помощью `within` или `as` + `find`.
   ```ts
   // Пример работы с модальным окном с заголовком "Добавить участника"
   cy.contains('.ant-modal-content', 'Добавить участника')
      .within(() => {
         // ...
      });

   // Пример с созданием алиаса для строки таблицы
   cy.contains('tr', participantName).as('participantRow');
   // далее цепочки начинаем с `cy.get('@participantRow').find('...').`
   // Важно учитывать, что цепочка из `cy.get().get()` работать не будет, 
   // второй вызов `get` снова будет искать элемент по всей странице.
   ```
3. Не используем `cy.wait`. Заменяем, например, на `should('be.visible')`.
   ```ts
   // Пример с ожиданием появления выпадающего списка с ролями
   cy.get('.ant-select-item').contains(newRole).should('be.visible').click();
   ```
4. Не используем `cy.eq`.
   ```ts
   // Так не делаем
   cy.get('button').eq(7).click();
   // Так делаем
   cy.contains('button', 'Добавить участника').should('be.visible').click();
   ```

## Добавление новых команд

1. Любые повторяющие дествия надо выносить в команды (`cypress/support/commands/`). 
2. Командам добавляем суффикс `UI`, если действия выполняются через интерфейс, либо суффикс `API`, если действия выполняются напрямую через API.
3. Команды группируем по файлам в соответствии с тегами из [спецификации API](../openapi/api.yml#L13).
4. Если команда принимает набор из нескольких параметров, то в [`cypress/support/types/index.ts`](cypress/support/types/index.ts) добавляем типы для этих параметров.
5. Определяем сигнатуру команды в [`cypress/support/commands/index.ts`](cypress/support/commands/index.ts). При определении команды тип аргументов указывать не нужно.
   ```ts
   // Так не делаем
   Cypress.Commands.add('addParticipantByLoginUI', (username: string)
   // Так делаем (типы подтянутся из сигнатуры)
   Cypress.Commands.add('addParticipantByLoginUI', (username)
   ```
6. Команда должна содержать код для проверки результата её выполнения. В случае UI команды, проверяем, что интерфейс изменился ожидаемым образом. В случае API команды, проверяем код ответа.
