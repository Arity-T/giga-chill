openapi: 3.0.0

info:
  title: GigaChill
  version: 0.1.0

servers:
  - url: http://localhost:3000

security:
  - CookieAuth: []

tags:
  - name: Auth
  - name: Me
  - name: Events
  - name: Invite Links
  - name: Participants
  - name: Shopping Lists
  - name: Shopping List Items
  - name: Shopping List Consumers

paths:
  /auth/login:
    post:
      summary: Аутентификация пользователя
      description: Возвращает JWT токен при успешной аутентификации.
      tags: [Auth]
      operationId: loginUser
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserLoginPassword"
      responses:
        "204":
          description: JWT отправлен в Set-Cookie (HttpOnly). Тело пустое.
        "401":
          description: Неверный логин или пароль
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/register:
    post:
      summary: Регистрация нового пользователя
      tags: [Auth]
      operationId: registerUser
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRegister"
      responses:
        "204":
          description: Пользователь создан. JWT-токен отправлен в Set-Cookie (HttpOnly). Тело пустое.
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "409":
          description: Пользователь с таким логином уже существует
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/logout:
    post:
      summary: Выход из системы
      description: Удаляет JWT токен из cookie.
      tags: [Auth]
      operationId: logoutUser
      responses:
        "204":
          description: Пользователь успешно вышел из системы. JWT токен удалён из cookie.
        "401":
          $ref: '#/components/responses/UnauthorizedError'
  /me:
    get:
      summary: Текущий пользователь
      description: Возвращает данные пользователя, идентифицированного по JWT.
      tags: [Me]
      operationId: getMe
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: '#/components/responses/UnauthorizedError'

  /events:
    get:
      summary: Список моих мероприятий
      description:
        Возвращает все мероприятия, в которых участвует аутентифицированный
        пользователь, вместе с его ролью в этих мероприятиях.
      tags: [Events]
      operationId: getEvents
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Events"
        "401":
          $ref: '#/components/responses/UnauthorizedError'

    post:
      summary: Создать мероприятие
      description: Автор запроса автоматически становится **owner**.
      tags: [Events]
      operationId: createEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'

  /events/{eventId}:
    get:
      summary: Получить мероприятие
      description:
        Возвращает мероприятие, в котором участвует аутентифицированный
        пользователь, вместе с его ролью в этом мероприятии.
      tags: [Events]
      operationId: getEvent
      parameters:
        - $ref: "#/components/parameters/eventId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Event"
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    patch:
      summary: Обновить мероприятие
      tags: [Events]
      operationId: updateEvent
      parameters:
        - $ref: "#/components/parameters/eventId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Event"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    delete:
      summary: Удалить мероприятие
      tags: [Events]
      operationId: deleteEvent
      parameters:
        - $ref: "#/components/parameters/eventId"
      responses:
        "204":
          description: No Content
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/invitation-token:
    post:
      summary: Создать новый токен
      description: Токен генерирует пользователь со статусом **owner**.
      tags: [Invite Links]
      operationId: createEventInvitationToken
      responses:
        "204":
          description: No Content
        "401":
          description: Токен отсутствует, истёк или некорректен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Недостаточно прав для создание ссылки на мероприятия (требуется роль owner)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Мероприятие не найдено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    get:
      summary: Получение токена
      description: Возвращает заранее сгенерированный токен-приглашение.
        Доступно пользователям с ролью **admin** или **owner**.
        Если токен ещё не был сгенерирован, то в поле token возвращается null.
      tags: [Invite Links]
      operationId: getEventInvitationToken
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvitationToken"
        "401":
          description: Токен отсутствует, истёк или некорректен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Недостаточно прав для просмотра ссылки на мероприятия (требуется роль admin или owner)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Мероприятие не найдено
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/join-by-link:
    post:
      summary: Присоединиться к мероприятию по токену
      description: Пользователь становится участником мероприятия.
      tags: [Invite Links]
      operationId: joinByInvitationToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InvitationToken"
      responses:
        "204":
          description: No Content
        "401":
          description: Токен отсутствует, истёк или некорректен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Мероприятие не найдено или ссылка не существует
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/{eventId}/participants:
    get:
      summary: Список участников
      tags: [Participants]
      operationId: getParticipants
      parameters:
        - $ref: "#/components/parameters/eventId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsersInEvent"
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    post:
      summary: Добавить участника
      description: Добавление по логину. Роль по умолчанию — **participant**.
      tags: [Participants]
      operationId: addParticipant
      parameters:
        - $ref: "#/components/parameters/eventId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserLogin"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "409":
          description: Пользователь уже является участником мероприятия
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /events/{eventId}/participants/{participantId}:
    delete:
      summary: Удалить участника
      tags: [Participants]
      operationId: deleteParticipant
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/participantId"
      responses:
        "204":
          description: No Content
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/participants/{participantId}/role:
    patch:
      summary: Изменить роль участника
      tags: [Participants]
      operationId: updateParticipantRole
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/participantId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRole"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists:
    get:
      summary: Получение списков покупок
      description:
        Возвращает все списки покупок, связанные с указанным мероприятием,
        вместе с элементами списков покупок и потребителями.
      tags: [Shopping Lists]
      operationId: getShoppingLists
      parameters:
        - $ref: "#/components/parameters/eventId"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ShoppingListsWithItems"
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    post:
      summary: Добавить список покупок
      tags: [Shopping Lists]
      operationId: addShoppingList
      parameters:
        - $ref: "#/components/parameters/eventId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShoppingListWithItems"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists/{shoppingListId}:
    patch:
      summary: Изменить список покупок
      tags: [Shopping Lists]
      operationId: updateShoppingList
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShoppingListWithItems"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    delete:
      summary: Удалить список покупок
      tags: [Shopping Lists]
      operationId: deleteShoppingList
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
      responses:
        "204":
          description: No Content
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists/{shoppingListId}/shopping-items:
    post:
      summary: Добавить элемент в список покупок
      tags: [Shopping List Items]
      operationId: addShoppingItem
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShoppingItem"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists/{shoppingListId}/shopping-items/{shoppingItemId}:
    patch:
      summary: Изменить элемент списка покупок
      tags: [Shopping List Items]
      operationId: updateShoppingItem
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
        - $ref: "#/components/parameters/shoppingItemId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShoppingItem"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

    delete:
      summary: Удалить элемент из списка покупок
      tags: [Shopping List Items]
      operationId: deleteShoppingItem
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
        - $ref: "#/components/parameters/shoppingItemId"
      responses:
        "204":
          description: No Content
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists/{shoppingListId}/shopping-items/{shoppingItemId}/purchased-state:
    patch:
      summary: Изменить статус элемента списка покупок
      tags: [Shopping List Items]
      operationId: updateShoppingItemPurchasedStatus
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
        - $ref: "#/components/parameters/shoppingItemId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ShoppingItemPurchasedState"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'

  /events/{eventId}/shopping-lists/{shoppingListId}/consumers:
    put:
      summary: Указать потребителей для списка покупок
      description: |
        Идемпотентное действие - список потребителей полностью заменяется.

        Есть некоторый риск, что один клиент перезапишет другого. 
        Не критично, но стоит иметь в виду. Вариант решения - ETag/If-Match.
      tags: [Shopping List Consumers]
      operationId: setConsumers
      parameters:
        - $ref: "#/components/parameters/eventId"
        - $ref: "#/components/parameters/shoppingListId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserIdList"
      responses:
        "204":
          description: No Content
        "400":
          $ref: '#/components/responses/InvalidDataError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "403":
          $ref: '#/components/responses/ForbiddenError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "409":
          description: Статус списка покупок не позволяет изменять потребителей
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    
components:
  responses:
    InvalidDataError:
      description: Невалидные данные в теле запроса
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    UnauthorizedError:
      description: Токен отсутствует, истёк или некорректен
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ForbiddenError:
      description: У пользователя недостаточно прав для выполнения операции
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFoundError:
      description: Один или несколько задействованных ресурсов не найдены
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
            
  parameters:
    eventId:
      name: eventId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      example: c014cfe2-7a69-4959-88f7-4a2b795c2a20

    participantId:
      name: participantId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      example: 0fab8e08-4b0d-4a3d-9771-9f6c6a9d5a1c

    shoppingListId:
      name: shoppingListId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      example: 0fab8e08-4b0d-4a3d-9771-9f6c6a9d5a1c

    shoppingItemId:
      name: shoppingItemId
      in: path
      required: true
      schema:
        type: string
        format: uuid
      example: 0fab8e08-4b0d-4a3d-9771-9f6c6a9d5a1c

  securitySchemes:
    CookieAuth:
      type: apiKey
      in: cookie
      name: token

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: Сообщение об ошибке
          example: "Something went wrong"
      required: [message]

    UserLogin:
      type: object
      properties:
        login:
          type: string
          description: Логин пользователя
          example: user123

    UserPassword:
      type: object
      properties:
        password:
          type: string
          description: Пароль пользователя
          example: mysecurepassword

    UserName:
      type: object
      properties:
        name:
          type: string
          description: Имя пользователя
          example: Иван Иванов

    UserLoginPassword:
      allOf:
        - $ref: "#/components/schemas/UserLogin"
        - $ref: "#/components/schemas/UserPassword"

    UserRegister:
      allOf:
        - $ref: "#/components/schemas/UserLogin"
        - $ref: "#/components/schemas/UserPassword"
        - $ref: "#/components/schemas/UserName"

    UserId:
      type: object
      properties:
        id:
          type: string
          description: Идентификатор пользователя
          example: c014cfe2-7a69-4959-88f7-4a2b795c2a20

    UserIdList:
      type: array
      items:
        type: string
        format: uuid
        description: Идентификатор пользователя

    User:
      allOf:
        - $ref: "#/components/schemas/UserLogin"
        - $ref: "#/components/schemas/UserName"
        - $ref: "#/components/schemas/UserId"

    UserRole:
      type: object
      properties:
        role:
          type: string
          enum: [owner, admin, participant]
          description: Роль пользователя в мероприятии
          example: owner

    UserInEvent:
      allOf:
        - $ref: "#/components/schemas/User"
        - type: object
          properties:
            user_role:
              readOnly: true
              type: string
              enum: [owner, admin, participant]
              description: Роль пользователя в мероприятии
              example: owner
            balance:
              type: number
              description: Баланс пользователя в мероприятии (сумма долгов)
              example: 200

    UsersInEvent:
      type: array
      items:
        $ref: "#/components/schemas/UserInEvent"

    Event:
      type: object
      properties:
        event_id:
          readOnly: true
          type: string
          description: Идентификатор мероприятия
          example: 123e4567-e89b-12d3-a456-426614174000
        user_role:
          readOnly: true
          type: string
          enum: [owner, admin, participant]
          description: Роль пользователя в мероприятии
          example: owner
        title:
          type: string
          description: Название мероприятия
          example: "Встреча с друзьями"
        location:
          type: string
          description: Место мероприятия
          example: Политехническая улица, 29 лит П
        start_datetime:
          type: string
          format: date-time
          description: Дата и время начала мероприятия
          example: "2025-01-01T10:00:00Z"
        end_datetime:
          type: string
          format: date-time
          description: Дата и время окончания мероприятия
          example: "2025-01-01T12:00:00Z"
        description:
          type: string
          description: Описание мероприятия
          example: "Встреча с друзьями в кафе"
        budget:
          readOnly: true
          type: number
          description: Бюджет мероприятия
          example: 10000

    InvitationToken:
      type: object
      properties:
        invitation_token:
          type: string
          description: Токен-приглашение
          example: "0fab8e08-4b0d-4a3d-9771-9f6c6a9d5a1c"

    Events:
      type: array
      items:
        $ref: "#/components/schemas/Event"

    ShoppingItem:
      type: object
      properties:
        shopping_item_id:
          readOnly: true
          type: string
          description: Идентификатор элемента списка покупок
          example: 123e4567-e89b-12d3-a456-426614174000
        title:
          type: string
          description: Название элемента списка покупок
          example: "Яблоки"
        quantity:
          type: number
          description: Количество элемента списка покупок
          example: 10
        unit:
          type: string
          description: Единицы измерения
          example: "шт"
        is_purchased:
          readOnly: true
          type: boolean
          description: Признак того, что элемент списка покупок куплен
          example: false

    ShoppingItems:
      type: array
      items:
        $ref: "#/components/schemas/ShoppingItem"

    ShoppingItemPurchasedState:
      type: object
      properties:
        is_purchased:
          type: boolean
          description: Признак того, что элемент списка покупок куплен
          example: false

    ShoppingListWithItems:
      type: object
      properties:
        shopping_list_id:
          readOnly: true
          type: string
          description: Идентификатор списка покупок
          example: 123e4567-e89b-12d3-a456-426614174000
        task_id:
          readOnly: true
          type: string
          description: Идентификатор связанной задачи
          example: 123e4567-e89b-12d3-a456-426614174000
        title:
          type: string
          description: Название задачи
          example: "Купить фрукты"
        description:
          type: string
          description: Описание списка покупок
          example: "Купить фрукты для вечеринки"
        status:
          readOnly: true
          type: string
          enum:
            [
              unassigned,
              assigned,
              in_progress,
              bought,
              partially_bought,
              cancelled,
            ]
          description: Статус списка покупок
          example: unassigned
        can_edit:
          readOnly: true
          type: boolean
          description: Может ли пользователь редактировать список покупок
          example: true
        shopping_items:
          readOnly: true
          type: array
          items:
            $ref: "#/components/schemas/ShoppingItem"
        consumers:
          readOnly: true
          type: array
          items:
            $ref: "#/components/schemas/UserInEvent"

    ShoppingListsWithItems:
      type: array
      items:
        $ref: "#/components/schemas/ShoppingListWithItems"
